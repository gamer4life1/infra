---
kind: pipeline
name: Run Ansible

platform:
  os: linux
  arch: arm64

steps:
- name: check ansible syntax
  image: plugins/ansible:1
  settings:
    playbook: playbooks/docker.yml
    inventory: hosts
    syntax_check: true
  when:
    event:
    - push
    - pull_request

- name: apply ansible playbook
  image: ansible-docker-aarch64:latest
  pull: never
  commands:
    - mkdir ~/.ssh
    - echo "$ansible_private_key" > $HOME/.ssh/id_rsa
    - echo "$ansible_public_key" > $HOME/.ssh/id_rsa.pub
    - chmod 600 $HOME/.ssh/id_rsa
    - chmod 600 $HOME/.ssh/id_rsa.pub
    - echo "$vault_password" > vault_password
    - ansible-playbook playbooks/docker.yml
  when:
    event:
    - push
    - tag
